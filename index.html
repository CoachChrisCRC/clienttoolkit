<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Tool Kit - Coach Chris</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Base Imports for Aesthetics */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Oswald:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column; /* Allows main content and footer to stack */
            align-items: center;
        }

        .font-brand {
            font-family: 'Oswald', sans-serif;
        }

        .tracking-ultra-wide {
            letter-spacing: 0.15em;
        }

        /* Input styling for the dark theme */
        input, select {
            background-color: #111111;
            border: 1px solid #333333;
            color: #ffffff;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #ffffff;
            box-shadow: 0 0 0 1px #ffffff;
        }
        
        /* Utility class for button hover effect */
        .btn-primary:hover {
            background-color: #2e2e2e;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
        }
        
        /* Custom modal styles for confirmation (Toast) */
        .modal-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #10B981; /* Green-500 */
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        .modal-toast.show {
            opacity: 1;
        }
        
        /* NEW: Main Application Modal Styles (Overlay and Content) */
        .app-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9); /* Dark overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50; 
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        
        .app-modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .app-modal-content {
            /* Ensures it looks like a contained app, scrolls internally, and is centered */
            width: 95%; 
            max-width: 500px;
            height: 100%; 
            max-height: 90vh; 
            background-color: #000000; 
            border-radius: 0.5rem;
            overflow-y: auto; 
            position: relative;
            transform: scale(0.9);
            transition: transform 0.3s ease-in-out;
            /* Flex layout to push the internal footer to the bottom */
            display: flex;
            flex-direction: column;
        }
        
        .app-modal-overlay.active .app-modal-content {
            transform: scale(1);
        }

        /* Initial page content styling */
        .page-header {
            width: 100%;
            max-width: 90%;
            padding: 2rem 1.5rem 1rem;
            text-align: center;
        }
        .page-tool-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            max-width: 900px;
            width: 90%;
            padding-bottom: 2rem;
        }
        .tool-card {
            background-color: #111111;
            padding: 2rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            border: 2px solid #333333;
        }
        .tool-card:hover {
            transform: translateY(-5px);
            background-color: #1e1e1e;
            border-color: #ffffff;
        }
        .tool-card-disabled {
             opacity: 0.5;
             cursor: default;
        }
    </style>
</head>
<body>
    
    <header class="page-header mt-8">
        <h1 class="font-brand font-extrabold text-6xl leading-none tracking-wide text-white mb-2">TOOL KIT</h1>
        <h2 class="font-brand font-bold text-xl leading-none text-gray-400 mb-4">COACH CHRIS CLIENT RESOURCE PORTAL</h2>
        <p class="text-gray-500 max-w-lg mx-auto">Select a tool below to access workout builders, performance calculators, and educational content.</p>
    </header>

    <div class="page-tool-grid flex-grow">
        
        <div id="launch-wod-btn" onclick="openModal()" class="tool-card flex flex-col items-center justify-center text-center bg-emerald-700/50 hover:bg-emerald-700">
            <i data-lucide="dumbbell" class="w-12 h-12 text-white mb-3"></i>
            <h3 class="font-brand text-2xl font-bold uppercase">WOD Generator</h3>
            <p class="text-sm text-gray-200 mt-1">Generate a structured workout instantly.</p>
        </div>

        <div class="tool-card tool-card-disabled flex flex-col items-center justify-center text-center">
            <i data-lucide="weight" class="w-12 h-12 text-white mb-3"></i>
            <h3 class="font-brand text-2xl font-bold uppercase">RPE / RIR Calculator</h3>
            <p class="text-sm text-gray-500 mt-1">Coming Soon: Calculate intensity scores.</p>
        </div>
        
        <div class="tool-card tool-card-disabled flex flex-col items-center justify-center text-center">
            <i data-lucide="calendar" class="w-12 h-12 text-white mb-3"></i>
            <h3 class="font-brand text-2xl font-bold uppercase">Custom Cycle Planner</h3>
            <p class="text-sm text-gray-500 mt-1">Coming Soon: Plan your training blocks.</p>
        </div>

    </div>
    
    <footer class="p-10 bg-black text-neutral-400 border-t border-white/20 mt-auto w-full">
        <div class="max-w-4xl mx-auto text-center">
            <p class="text-xs mb-6 leading-relaxed">
                General Fitness Disclaimer: Always consult your medical professional or doctor before you begin any fitness regime or make changes to your diet. This site provides general information for educational purposes only and is not intended to diagnose or treat any medical condition. You engage in physical activity at your own risk.
            </p>
            <p class="text-sm font-semibold text-white mb-2">
                &copy; <span id="current-year-page">2025</span> COACH CHRIS | CIRCULAR ROOTS COACHING | TRAIN UNCNVNTNL. All rights reserved.
            </p>
            <p class="text-sm font-medium">
                Fitter. Stronger. Better.
            </p>
        </div>
    </footer>
    
    <div id="app-modal-overlay" class="app-modal-overlay" onclick="closeModal(event)">
        <div id="app-modal-content" class="app-modal-content" onclick="event.stopPropagation()">
            
            <button onclick="closeModal()" class="absolute top-4 right-4 text-white hover:text-red-500 transition-colors z-10">
                <i data-lucide="x" class="w-8 h-8"></i>
            </button>
            
            <header class="w-full max-w-md px-6 py-8 flex justify-between items-start mx-auto">
                <div class="flex flex-col select-none">
                    <h1 class="font-brand font-extrabold text-4xl leading-none tracking-wide text-white mb-1">COACH CHRIS</h1>
                    <h2 class="font-brand font-bold text-lg leading-none text-gray-400 mb-[2px]">CIRCULAR ROOTS COACHING</h2>
                    <h3 class="font-brand font-bold text-lg leading-none text-gray-600">TRAIN UNCNVNTNL</h3>
                </div>
                <div class="text-white pt-1">
                    <i data-lucide="zap" class="w-8 h-8"></i>
                </div>
            </header>

            <main class="w-full max-w-md p-6 sm:p-8 mx-auto flex-grow">
                
                <h2 class="font-brand text-4xl uppercase tracking-widest font-bold mb-4 text-center">WOD Generator</h2>
                <p class="text-center text-sm text-gray-400 mb-8">Generate a quick 15-30 minute workout.</p>

                <div id="wod-input-form" class="space-y-4">
                    <label class="block">
                        <span class="text-sm font-bold block mb-1">Equipment</span>
                        <select id="wod-equipment" class="w-full">
                            <option value="combined">Kettlebell & Bodyweight (Combined)</option>
                            <option value="kettlebell">Kettlebell Only</option>
                            <option value="bodyweight">Bodyweight Only</option>
                        </select>
                    </label>
                    <label class="block">
                        <span class="text-sm font-bold block mb-1">Workout Format</span>
                        <select id="wod-format" class="w-full">
                            <option value="random">Random Format</option>
                            <option value="AMRAP">AMRAP (As Many Rounds As Possible)</option>
                            <option value="EMOM">EMOM (Every Minute On the Minute)</option>
                            <option value="FOR TIME">FOR TIME (Fixed Rounds)</option>
                            <option value="CHIPPER">Chipper (High Rep)</option>
                            <option value="LADDER 10-1">Descending Ladder (10-1)</option>
                            <option value="LADDER 20-2">Descending Ladder (20-2)</option>
                            <option value="TABATA">Timed Intervals (Tabata: 20s/10s)</option>
                            <option value="INTERVAL_30_30">Timed Intervals (30s Work / 30s Rest)</option>
                            <option value="INTERVAL_60_30">Timed Intervals (60s Work / 30s Rest)</option>
                            <option value="INTERVAL_90_30">Timed Intervals (90s Work / 30s Rest)</option>
                        </select>
                    </label>
                    
                    <button onclick="generateWOD()" class="w-full mt-6 py-4 bg-white text-black text-xl font-bold uppercase rounded-sm hover:opacity-80 transition-opacity">
                        Generate WOD
                    </button>
                </div>

                <div id="wod-result" class="mt-8 pt-6 border-t border-gray-700 space-y-6 hidden">
                    <h3 class="text-xl font-bold uppercase tracking-wider mb-2">Your Workout of the Day:</h3>
                    
                    <div class="p-4 border border-white rounded-lg" id="wod-summary-container">
                        <p class="text-sm uppercase text-gray-400 mb-1">Purpose</p>
                        <p class="text-lg font-bold mb-3 text-emerald-400" id="wod-purpose-display">Placeholder</p>
                        
                        <p class="text-sm uppercase text-gray-400 mb-1">Format</p>
                        <p class="text-3xl font-brand font-bold" id="wod-format-display">AMRAP</p>
                        
                        <p class="text-sm uppercase text-gray-400 mt-3 mb-1">Time Goal / Structure</p>
                        <p class="text-lg font-bold" id="wod-goal-display">20 Minute Time Cap</p>
                    </div>

                    <div class="space-y-4" id="wod-instructions">
                        </div>
                    
                    <button onclick="copyWODToClipboard()" class="w-full flex items-center justify-center space-x-2 py-3 bg-gray-700 text-white text-base font-semibold uppercase rounded-md transition-all btn-primary">
                        <i data-lucide="clipboard" class="w-5 h-5"></i>
                        <span>Copy WOD to Clipboard</span>
                    </button>

                    <button onclick="resetWOD()" class="w-full py-3 text-sm font-bold uppercase tracking-wider opacity-60 hover:opacity-100 transition-opacity">
                        GENERATE NEW WOD
                    </button>
                </div>
                <p id="wod-error" class="text-red-500 text-sm mt-4 hidden text-center">
                    An error occurred during generation.
                </p>
            </main>
            
            <footer class="p-10 bg-black text-neutral-400 border-t border-white/20 mt-auto w-full">
                <div class="max-w-4xl mx-auto text-center">
                    <p class="text-xs mb-6 leading-relaxed">
                        Disclaimer: Always consult a professional before beginning any fitness regime. Use this tool at your own risk.
                    </p>
                    <p class="text-sm font-semibold text-white mb-2">
                        &copy; <span id="current-year-modal">2025</span> COACH CHRIS. 
                    </p>
                </div>
            </footer>
        </div>
    </div>


    <div id="copy-modal" class="modal-toast">
        WOD copied to clipboard!
    </div>


    <script>
        // --- NEW MODAL CONTROL FUNCTIONS ---
        const modalOverlay = document.getElementById('app-modal-overlay');

        /**
         * Opens the main WOD Generator modal.
         */
        function openModal() {
            modalOverlay.classList.add('active');
            // Ensure the main app content is reset when opened
            resetWOD(); 
        }

        /**
         * Closes the main WOD Generator modal.
         * @param {Event} event - Optional click event to check if the click target was the overlay itself.
         */
        function closeModal(event) {
            // Check if event exists AND if the clicked element is the overlay itself.
            if (!event || event.target.id === 'app-modal-overlay') {
                modalOverlay.classList.remove('active');
            }
        }
        
        // Initialize Lucide Icons
        lucide.createIcons();
        
        // --- JS Helper Functions ---
        const randItem = (arr) => arr[Math.floor(Math.random() * arr.length)];
        const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const isUnilateral = (m) => m.name.includes('(per side)') || m.name.includes('(per leg)');
        const GREEN_ASTERISK = '<span class="text-green-400">*</span>';
        
        // Global variable to store the plain text WOD for copying
        let currentWODText = "";

        /**
         * Shows a temporary confirmation modal (Toast).
         */
        function showCopyConfirmation() {
            const modal = document.getElementById('copy-modal');
            if (modal) {
                modal.classList.add('show');
                setTimeout(() => {
                    modal.classList.remove('show');
                }, 2000);
            }
        }
        
        /**
         * Formats and copies the generated WOD to the clipboard.
         */
        function copyWODToClipboard() {
            if (currentWODText) {
                const tempTextarea = document.createElement('textarea');
                tempTextarea.value = currentWODText;
                document.body.appendChild(tempTextarea);
                tempTextarea.select();
                try {
                    document.execCommand('copy');
                    showCopyConfirmation();
                } catch (err) {
                    console.error('Failed to copy text:', err);
                }
                document.body.removeChild(tempTextarea);
            }
        }


        // --- WOD MOVEMENT DATA (Retained from previous turn) ---
        const KB_MOVEMENTS = [
            { name: "Kettlebell Swings (Russian)", reps: [15, 25], fastReps: [12, 20], category: 'C' }, 
            { name: "Goblet Squats", reps: [10, 15], fastReps: [8, 12], category: 'L' },
            { name: "Single-Arm Clean & Press (per side)", reps: [5, 10], fastReps: [4, 6], category: 'U' }, 
            { name: "Kettlebell Thrusters", reps: [8, 12], fastReps: [6, 10], category: 'C' },
            { name: "Kettlebell Snatch (per side)", reps: [8, 12], fastReps: [5, 8], category: 'C' }, 
            { name: "Kettlebell Renegade Rows (per side)", reps: [10, 15], fastReps: [4, 8], category: 'U' }, 
            { name: "Kettlebell Deadlifts", reps: [15, 25], fastReps: [12, 20], category: 'L' },
        ];

        const BW_MOVEMENTS = [
            { name: "Air Squats", reps: [20, 30], fastReps: [15, 20], category: 'L' },
            { name: "Push-ups (Standard)", reps: [10, 20], fastReps: [8, 12], category: 'U' }, 
            { name: "Burpees", reps: [5, 12], fastReps: [4, 10], category: 'C' },
            { name: "Walking Lunges (per leg)", reps: [10, 15], fastReps: [6, 10], category: 'L' }, 
            { name: "V-Ups / Sit-ups", reps: [15, 25], fastReps: [12, 20], category: 'C' },
            { name: "Mountain Climbers (per leg)", reps: [20, 30], fastReps: [15, 25], category: 'C' },
            { name: "Plank Hold (seconds)", reps: [30, 60], fastReps: [20, 45], category: 'C' },
        ];
        
        const WOD_FORMATS = ["AMRAP", "EMOM", "FOR TIME", "CHIPPER", "LADDER 10-1", "LADDER 20-2", "TABATA", "INTERVAL_30_30", "INTERVAL_60_30", "INTERVAL_90_30"];
        
        // --- WOD PURPOSE MAPPING ---
        const WOD_PURPOSE_MAP = {
            "AMRAP": "High-Volume Full-Body Stamina. Test your sustained intensity.",
            "FOR TIME": "Structured Strength-Endurance. Aim for consistent round times.",
            "CHIPPER": "Mental Toughness & Grinding Capacity. Break large sets early.",
            "LADDER 10-1": "Low-Volume Power Endurance. Max effort, minimal rest.",
            "LADDER 20-2": "High-Volume Unilateral Stamina. Manage fatigue through large rep drops.",
            "EMOM": "Consistency & Pacing Drill. Maximize efficiency to earn rest.",
            "TABATA": "Anaerobic Power & Conditioning. Maintain max effort output.",
            "INTERVAL_30_30": "High-Intensity Interval Training (HIIT). Equal work/rest ratio.",
            "INTERVAL_60_30": "Aerobic Power Intervals. Test your sustained output under fatigue.",
            "INTERVAL_90_30": "Long Duration Sustained Power. Focus on internal pacing cues.",
        };
        
        // --- CONCISE COACHING NOTES ---
        const SCALING_NOTE_REP_ROUND_CONCISE = "Reduce reps/choose easier variation to maintain movement quality if pace drops off.";
        const SCALING_NOTE_EMOM_CONCISE = "If work takes >45s, immediately reduce reps/scale movement to ensure rest time is earned.";
        const SCALING_NOTE_INTERVAL_CONCISE = "Use lower-impact variation to maintain intensity for the full work period.";
        const UNILATERAL_NOTE_EMOM = "*UNI: Alt sides/legs during the minute.";
        const UNILATERAL_NOTE_REP_ROUND = "*UNI: Total reps listed. Alt sides/legs.";
        const UNILATERAL_NOTE_INTERVAL = "*UNI: Alt sides/legs during work period.";

        const PACING_NOTE = {};
        PACING_NOTE.AMRAP = "Find a sustainable pace for the full duration. Avoid burning out in the first 5 mins.";
        PACING_NOTE.FORTIME = "Aim for quick, consistent rounds. Break movements early to avoid hitting a wall.";
        PACING_NOTE.CHIPPER = "Break large numbers into small sets (5-10 reps) early. Prioritize form over speed.";
        PACING_NOTE.LADDER = "Treat high-rep rounds (start) like a FOR TIME piece. The decrease in volume offers a psychological win later.";
        PACING_NOTE.EMOM = "Complete work in 35-45s max to earn rest. Consistency is key.";
        PACING_NOTE.TABATA = "Maximal effort. Maintain intensity and minimize rep drop-off across the 8 rounds.";
        PACING_NOTE.INTERVAL_30_30 = "Push hard for 30s. Use the 30s rest for full recovery to maintain quality across all blocks.";
        PACING_NOTE.INTERVAL_60_30 = "1:2 rest/work ratio is challenging. Break the movement up intelligently to avoid burning out early.";
        PACING_NOTE.INTERVAL_90_30 = "High-demand work. Find a steady, sustainable pace that ensures good form for the full 90 seconds.";


        /**
         * Calculates a logical, rounded rep count based on the movement type and required range.
         */
        const getLogicalReps = (movementName, min, max, isChipper = false) => {
            if (movementName.includes("Plank Hold")) {
                let reps = isChipper ? randInt(40, 65) : randInt(min, max);
                return Math.max(15, Math.round(reps / 15) * 15);
            }
            
            let reps = randInt(min, max);
            let roundingFactor = 5; 

            if (movementName.includes("Clean & Press") || movementName.includes("Thrusters") || 
                movementName.includes("Snatch") || movementName.includes("Burpees") ||
                movementName.includes("Push-ups") || movementName.includes("Lunges") ||
                movementName.includes("Renegade Rows")) {
                roundingFactor = 2;
            }
            
            let finalReps = Math.round(reps / roundingFactor) * roundingFactor;

            if (finalReps < min) {
                finalReps = Math.ceil(min / roundingFactor) * roundingFactor;
            } else if (finalReps > max) {
                finalReps = Math.floor(max / roundingFactor) * roundingFactor;
            }

            return Math.max(1, finalReps);
        };

        /**
         * Selects a specified number of unique movements.
         */
        function getMovements(equipment, count, filterTimeBased = false) {
            let allMoves = [];
            
            const bwFiltered = BW_MOVEMENTS.filter(m => !filterTimeBased || !m.name.includes("Plank Hold"));

            if (equipment === 'kettlebell') {
                allMoves = [...KB_MOVEMENTS];
            } else if (equipment === 'bodyweight') {
                allMoves = [...bwFiltered];
            } else { // combined
                allMoves = [...KB_MOVEMENTS, ...bwFiltered];
            }
            
            let lowerMoves = allMoves.filter(m => m.category === 'L');
            let upperMoves = allMoves.filter(m => m.category === 'U');
            let coreCardioMoves = allMoves.filter(m => m.category === 'C');
            
            let selectedMoves = [];
            let neededCount = count;

            // Enforce balance (1 Lower, 1 Upper)
            if (lowerMoves.length > 0) {
                const move = randItem(lowerMoves);
                selectedMoves.push(move);
                lowerMoves = lowerMoves.filter(m => m !== move);
                neededCount--;
            }

            if (upperMoves.length > 0 && neededCount > 0) {
                const move = randItem(upperMoves);
                selectedMoves.push(move);
                upperMoves = upperMoves.filter(m => m !== move);
                neededCount--;
            }

            // Fill remaining slots
            let remainingPool = [...lowerMoves, ...upperMoves, ...coreCardioMoves];
            
            // Shuffle
            for (let i = remainingPool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [remainingPool[i], remainingPool[j]] = [remainingPool[j], remainingPool[i]];
            }

            selectedMoves = [...selectedMoves, ...remainingPool.slice(0, neededCount)];

            // Final shuffle for order
            for (let i = selectedMoves.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [selectedMoves[i], selectedMoves[j]] = [selectedMoves[j], selectedMoves[i]];
            }
            
            return selectedMoves;
        }

        /**
         * Selects movements specifically for ladder formats.
         */
        function getLadderMovements(equipment, count, isHighVolumeUnilateral) {
            let allMoves = [...KB_MOVEMENTS, ...BW_MOVEMENTS].filter(m => !m.name.includes("Plank Hold"));
                
            if (equipment === 'kettlebell') {
                allMoves = allMoves.filter(m => KB_MOVEMENTS.includes(m));
            } else if (equipment === 'bodyweight') {
                allMoves = allMoves.filter(m => BW_MOVEMENTS.includes(m));
            }
            
            let selectedMoves = [];
            
            if (isHighVolumeUnilateral) { 
                const unilateralPool = allMoves.filter(isUnilateral);
                if (unilateralPool.length === 0) throw new Error("Ladder 20-2 requires equipment with unilateral movements.");
                const mandatoryUni = randItem(unilateralPool);
                selectedMoves.push(mandatoryUni);
                let remainingPool = allMoves.filter(m => m !== mandatoryUni);
                let remainingNeeded = Math.min(Math.max(0, count - 1), remainingPool.length);
                for (let i = remainingPool.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [remainingPool[i], remainingPool[j]] = [remainingPool[j], remainingPool[i]];
                }
                selectedMoves = [...selectedMoves, ...remainingPool.slice(0, remainingNeeded)];

            } else { 
                const bilateralPool = allMoves.filter(m => !isUnilateral(m));
                if (bilateralPool.length < count) throw new Error("Ladder 10-1 requires equipment with enough bilateral movements.");
                let pool = [...bilateralPool];
                for (let i = pool.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [pool[i], pool[j]] = [pool[j], pool[i]]; 
                }
                selectedMoves = pool.slice(0, count);
            }
            
            for (let i = selectedMoves.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [selectedMoves[i], selectedMoves[j]] = [selectedMoves[j], selectedMoves[i]];
            }

            if (selectedMoves.length < 2) {
                 throw new Error("Could not select a minimum of 2 movements for the ladder format.");
            }
            
            return selectedMoves;
        }

        /**
         * Generates and displays the Workout of the Day based on form inputs.
         */
        function generateWOD() {
            const equipment = document.getElementById('wod-equipment').value;
            let format = document.getElementById('wod-format').value;
            const resultDiv = document.getElementById('wod-result');
            const formDiv = document.getElementById('wod-input-form');
            const formatDisplay = document.getElementById('wod-format-display');
            const purposeDisplay = document.getElementById('wod-purpose-display');
            const goalDisplay = document.getElementById('wod-goal-display');
            const instructionsDiv = document.getElementById('wod-instructions');

            if (format === 'random') {
                const nonSpecializedFormats = WOD_FORMATS.filter(f => !f.startsWith("LADDER") && !f.startsWith("INTERVAL") && f !== "TABATA");
                format = randItem(nonSpecializedFormats);
            }
            
            const baseFormatKey = format.replace("LADDER 10-1", "LADDER 10-1").replace("LADDER 20-2", "LADDER 20-2");
            let purposeText = WOD_PURPOSE_MAP[baseFormatKey] || "General conditioning workout.";

            let goalText = '';
            let instructionsHtml = '';
            let instructionsText = ''; 
            let movements;
            let needsUnilateralNote = false; 
            let timeCap;
            let pacingNoteConcise = '';
            let scalingNoteConcise = '';

            try {
                switch (format) {
                    case "AMRAP":
                    case "FOR TIME":
                    case "CHIPPER":
                    case "LADDER 10-1":
                    case "LADDER 20-2":
                        
                        if (format.startsWith("LADDER")) {
                            const repInterval = format === "LADDER 10-1" ? 1 : 2;
                            const ladderStart = format === "LADDER 10-1" ? 10 : 20;
                            const isHighVolumeUnilateral = format === "LADDER 20-2";
                            const targetCount = isHighVolumeUnilateral ? randInt(2, 3) : randInt(3, 4);
                            movements = getLadderMovements(equipment, targetCount, isHighVolumeUnilateral);
                            timeCap = format === "LADDER 10-1" ? randItem([12, 15]) : randItem([18, 22]);
                        } else {
                            timeCap = randItem([12, 15, 18, 20]);
                            movements = getMovements(equipment, randInt(2, format === "FOR TIME" ? 5 : 4), false);
                        }

                        if (format === "AMRAP") pacingNoteConcise = PACING_NOTE.AMRAP;
                        else if (format === "FOR TIME") pacingNoteConcise = PACING_NOTE.FORTIME;
                        else if (format === "CHIPPER") pacingNoteConcise = PACING_NOTE.CHIPPER;
                        else if (format.startsWith("LADDER")) pacingNoteConcise = PACING_NOTE.LADDER;
                        scalingNoteConcise = SCALING_NOTE_REP_ROUND_CONCISE;

                        const processedMovesRepBased = movements.map((m, i) => {
                            let finalReps;
                            let name = m.name;
                            let movementIsUnilateral = isUnilateral(m);

                            let repRange = m.reps;
                            finalReps = getLogicalReps(name, repRange[0], repRange[1], format === "CHIPPER");
                            
                            if (format === "CHIPPER" && !name.includes("Plank Hold")) {
                                const repStart = randItem([100, 80, 60]);
                                const repFactor = (i / movements.length) * 0.4; 
                                let reps = repStart - Math.round(repStart * repFactor);
                                finalReps = Math.max(10, Math.round(reps / 5) * 5); 
                            }

                            if (movementIsUnilateral && !name.includes("Plank Hold")) {
                                finalReps *= 2;
                                name = name.replace(' (per side)', '').replace(' (per leg)', '') + GREEN_ASTERISK;
                            }
                            
                            const textName = name.replace(GREEN_ASTERISK, ''); 
                            return { movement: m, name, finalReps, textName };
                        });
                        
                        let instructionsHtmlBody = processedMovesRepBased.map(m => {
                            return `<div class="p-2 bg-gray-900 rounded-md font-mono text-lg">${m.finalReps} x ${m.name}</div>`;
                        }).join('\n');
                        
                        instructionsText = processedMovesRepBased.map(m => {
                            if (isUnilateral(m.movement)) needsUnilateralNote = true; 
                            return `${m.finalReps} ${m.textName}`;
                        }).join('\n');

                        let headerLine;
                        let secondaryInstruction = '';

                        if (format === "AMRAP") {
                            goalText = `AMRAP (As Many Rounds As Possible) - Time Cap: ${timeCap} Minutes`;
                            headerLine = `AMRAP ${timeCap} Min`;
                            secondaryInstruction = `Perform the following circuit, cycling through the movements in order until the time cap is reached.`;
                            
                            instructionsHtml = instructionsHtmlBody;
                            instructionsHtml += `<p class="mt-4 text-sm text-yellow-400 font-bold">Pacing Notes: ${pacingNoteConcise}</p><p class="mt-2 text-sm text-gray-400">${secondaryInstruction} Focus on movement quality while maintaining high intensity.</p><p class="mt-4 text-sm text-blue-400 font-bold">Scaling Notes: ${scalingNoteConcise}</p>`;

                        } else if (format === "FOR TIME") {
                            const numRounds = randItem([4, 5, 6]);
                            goalText = `FOR TIME: ${numRounds} Rounds (Time Cap: ${timeCap} Minutes)`;
                            headerLine = `FT ${numRounds} Rds | TC ${timeCap} Min`;
                            secondaryInstruction = `Complete ${numRounds} Rounds of the sequence below. Record your total time.`;

                            instructionsHtml = `<p class="font-bold text-xl mb-3">Complete ${numRounds} Rounds of:</p><div class="space-y-2">${instructionsHtmlBody}</div><p class="mt-4 text-sm text-yellow-400 font-bold">Pacing Notes: ${pacingNoteConcise}</p><p class="mt-2 text-sm text-gray-400">${secondaryInstruction} Break reps as needed. Maintain structural integrity.</p><p class="mt-4 text-sm text-blue-400 font-bold">Scaling Notes: ${scalingNoteConcise}</p>`;
                            
                        } else if (format === "CHIPPER") {
                            goalText = `CHIPPER: For Time (Time Cap: ${timeCap} Minutes)`; 
                            headerLine = `CHIPPER | TC ${timeCap} Min`;
                            secondaryInstruction = `Complete all movements in the order listed. Reps must be completed before moving to the next exercise.`;

                            instructionsHtml = `<p class="font-bold text-xl mb-3">Complete all movements in the order listed:</p><div class="space-y-2">${instructionsHtmlBody}</div><p class="mt-4 text-sm text-yellow-400 font-bold">Pacing Notes: ${pacingNoteConcise}</p><p class="mt-2 text-sm text-gray-400">${secondaryInstruction} If you hit the cap, record your total reps completed.</p><p class="mt-4 text-sm text-blue-400 font-bold">Scaling Notes: ${scalingNoteConcise}</p>`;
                            
                        } else { // LADDERS
                            const repInterval = format === "LADDER 10-1" ? 1 : 2;
                            const ladderStart = format === "LADDER 10-1" ? 10 : 20;
                            const roundsArray = Array.from({ length: ladderStart / repInterval }, (_, i) => ({
                                repCount: ladderStart - (i * repInterval),
                                roundIndex: i + 1
                            })); 
                            
                            goalText = `FOR TIME: Descending Ladder ${ladderStart}-${repInterval} (Time Cap: ${timeCap} Minutes)`;
                            headerLine = `LADDER ${ladderStart}-${repInterval} | TC ${timeCap} Min`;
                            secondaryInstruction = `Complete the following rounds in order, descending from ${ladderStart} to ${repInterval}.`;

                            instructionsText = roundsArray.map(round => {
                                const repCount = round.repCount;
                                const movesTextList = processedMovesRepBased.map(m => {
                                    if (isUnilateral(m.movement)) needsUnilateralNote = true;
                                    return m.textName;
                                }).join(' / ');
                                return `R${round.roundIndex} (${repCount} reps): ${movesTextList}`;
                            }).join('\n');

                            let roundsHtml = roundsArray.map(round => {
                                const repCount = round.repCount;
                                const roundIndex = round.roundIndex;
                                const movesList = processedMovesRepBased.map(m => {
                                    return `<div class="p-2 bg-gray-900 rounded-md font-mono text-lg">${repCount} x ${m.name}</div>`;
                                }).join('');
                                return `<div class="p-4 bg-gray-800 rounded-lg space-y-2"><h4 class="font-bold text-xl mb-1 text-white tracking-wider font-brand">ROUND ${roundIndex} (REPS: ${repCount})</h4><div class="space-y-1">${movesList}</div></div>`;
                            }).join('');
                            
                            instructionsHtml = `<p class="font-bold text-xl mb-3">${secondaryInstruction} You must complete all movements in a round before decreasing reps for the next round:</p><div class="space-y-3">${roundsHtml}</div><p class="mt-4 text-sm text-yellow-400 font-bold">Pacing Notes: ${pacingNoteConcise}</p><p class="mt-2 text-sm text-gray-400">Record your total time to completion. If you hit the cap, record the round/reps completed.</p><p class="mt-4 text-sm text-blue-400 font-bold">Scaling Notes: ${scalingNoteConcise}</p>`;
                        }
                        
                        currentWODText = `WOD | ${headerLine}\nPURPOSE: ${purposeText}\n\n${secondaryInstruction}\n\n${instructionsText}\n\n--- COACHING NOTES ---\nPACING: ${pacingNoteConcise}\nSCALING: ${scalingNoteConcise}`;

                        if (needsUnilateralNote) {
                            currentWODText += `\n\n${UNILATERAL_NOTE_REP_ROUND}`;
                            instructionsHtml += `<p class="mt-4 text-sm text-green-400 font-bold">UNILATERAL KEY ${GREEN_ASTERISK}: For movements marked with an asterisk, the reps listed are the TOTAL count (e.g., 20 reps = 10 per side/leg). Alternate sides as needed.</p>`;
                        }

                        break;

                    case "EMOM":
                        movements = getMovements(equipment, randInt(2, 4), false);
                        timeCap = randItem([16, 20, 24]);
                        goalText = `${timeCap} Minute EMOM (Every Minute On the Minute) - Time Cap: ${timeCap} Minutes`;

                        pacingNoteConcise = PACING_NOTE.EMOM;
                        scalingNoteConcise = SCALING_NOTE_EMOM_CONCISE;

                        const processedMovesEmom = movements.map((m, i) => {
                            let finalReps = getLogicalReps(m.name, m.fastReps[0], m.fastReps[1], false);
                            let name = m.name;
                            if (isUnilateral(m) && !name.includes("Plank Hold")) {
                                needsUnilateralNote = true;
                                finalReps *= 2;
                                name = name.replace(' (per side)', '').replace(' (per leg)', '') + GREEN_ASTERISK;
                            }
                            const textName = name.replace(GREEN_ASTERISK, ''); 
                            const minuteType = (movements.length > 1) ? `Minute ${(i % movements.length) + 1}` : 'Every Minute';
                            return { movement: m, name, finalReps, minuteType, textName };
                        });

                        instructionsText = processedMovesEmom.map(m => {
                            if (isUnilateral(m.movement)) needsUnilateralNote = true;
                            return `${m.minuteType.replace('Minute ', 'M')}: ${m.finalReps} ${m.textName}`;
                        }).join('\n');
                        
                        const secondaryInstructionEMOM = `Perform the work in the minute. Rest for the remainder of the minute. Repeat for ${timeCap} minutes.`;
                        currentWODText = `WOD | EMOM ${timeCap} Min\nPURPOSE: ${purposeText}\n\n${secondaryInstructionEMOM}\n\n${instructionsText}\n\n--- COACHING NOTES ---\nPACING: ${pacingNoteConcise}\nSCALING: ${scalingNoteConcise}`;

                        if (needsUnilateralNote) {
                            currentWODText += `\n\n${UNILATERAL_NOTE_EMOM}`;
                        }

                        instructionsHtml = processedMovesEmom.map(m => {
                            return `<div class="p-2 bg-gray-900 rounded-md font-mono text-lg">${m.minuteType}: ${m.finalReps} x ${m.name}</div>`;
                        }).join('');
                        instructionsHtml += `<p class="mt-4 text-sm text-yellow-400 font-bold">Pacing Notes: ${pacingNoteConcise}</p><p class="mt-2 text-sm text-gray-400">${secondaryInstructionEMOM}</p><p class="mt-4 text-sm text-blue-400 font-bold">Scaling Notes: ${scalingNoteConcise}</p>`;

                        if (needsUnilateralNote) {
                            instructionsHtml += `<p class="mt-4 text-sm text-green-400 font-bold">UNILATERAL KEY ${GREEN_ASTERISK}: For movements marked with an asterisk, alternate sides during the work block.</p>`;
                        }
                        break;

                    case "TABATA":
                    case "INTERVAL_30_30":
                    case "INTERVAL_60_30":
                    case "INTERVAL_90_30":
                        let workTime, restTime, numRoundsPerBlock, totalBlocks, description, formatLabel, conciseFormatLabel, intervalFormatKey;
                        
                        switch (format) {
                            case "TABATA": workTime = 20; restTime = 10; numRoundsPerBlock = 8; totalBlocks = randItem([3, 4]); formatLabel = "TABATA (20s/10s)"; conciseFormatLabel = "TABATA"; description = "8 rounds of 20 seconds maximal effort work / 10 seconds rest."; intervalFormatKey = "TABATA"; break;
                            case "INTERVAL_30_30": workTime = 30; restTime = 30; numRoundsPerBlock = randItem([5, 6]); totalBlocks = randItem([2, 3]); formatLabel = "30/30 INTERVALS (30s/30s)"; conciseFormatLabel = "30/30 Int"; description = `${numRoundsPerBlock} rounds of 30 seconds work / 30 seconds rest.`; intervalFormatKey = "INTERVAL_30_30"; break;
                            case "INTERVAL_60_30": workTime = 60; restTime = 30; numRoundsPerBlock = randItem([4, 5]); totalBlocks = randItem([2, 3]); formatLabel = "60/30 INTERVALS (60s/30s)"; conciseFormatLabel = "60/30 Int"; description = `${numRoundsPerBlock} rounds of 60 seconds work / 30 seconds rest.`; intervalFormatKey = "INTERVAL_60_30"; break;
                            case "INTERVAL_90_30": workTime = 90; restTime = 30; numRoundsPerBlock = randItem([3, 4]); totalBlocks = randItem([2, 3]); formatLabel = "90/30 INTERVALS (90s/30s)"; conciseFormatLabel = "90/30 Int"; description = `${numRoundsPerBlock} rounds of 90 seconds work / 30 seconds rest.`; intervalFormatKey = "INTERVAL_90_30"; break;
                        }
                        
                        pacingNoteConcise = PACING_NOTE[intervalFormatKey];
                        scalingNoteConcise = SCALING_NOTE_INTERVAL_CONCISE;

                        const blockTime = numRoundsPerBlock * (workTime + restTime) / 60;
                        timeCap = Math.ceil(blockTime * totalBlocks) + totalBlocks * randInt(1, 2);

                        let movesPerBlock = (format === "TABATA" || format === "INTERVAL_30_30") ? (totalBlocks === 2 ? 2 : 1) : 1;
                        
                        movements = getMovements(equipment, movesPerBlock * totalBlocks, false); 

                        let intervalBodyText = '';
                        let blockInstructions = '';

                        for (let i = 0; i < totalBlocks; i++) {
                            const movesInBlock = movements.slice(i * movesPerBlock, (i + 1) * movesPerBlock);
                            
                            let blockMovementsHtml = movesInBlock.map(m => {
                                let name = m.name;
                                if (isUnilateral(m)) {
                                    name = name.replace(' (per side)', '').replace(' (per leg)', '') + GREEN_ASTERISK;
                                    needsUnilateralNote = true;
                                }
                                return `<div class="p-2 bg-gray-900 rounded-md font-mono text-lg">${name}</div>`;
                            }).join('');
                            
                            let blockMovementsText = movesInBlock.map(m => {
                                let name = m.name;
                                if (isUnilateral(m)) {
                                    needsUnilateralNote = true;
                                    name = name.replace(' (per side)', '').replace(' (per leg)', '');
                                }
                                return name;
                            }).join(' & ');

                            intervalBodyText += `Block ${i + 1}: ${blockMovementsText}\n`;

                            blockInstructions += `<div class="p-4 bg-gray-800 rounded-lg space-y-2"><h4 class="font-bold text-xl mb-1 text-white tracking-wider font-brand">BLOCK ${i + 1}</h4><p class="text-sm text-gray-300 mb-2">${description}</p><p class="font-mono text-lg font-bold uppercase text-gray-400">Movement(s) to Perform:</p><div class="space-y-1">${blockMovementsHtml}</div></div>`;
                        }

                        goalText = `INTERVAL WORKOUT (${formatLabel}) - Total Time: Approx ${timeCap} Minutes`;
                        
                        const totalRounds = totalBlocks * numRoundsPerBlock;
                        const conciseHeader = format === "TABATA" ? `TABATA ${totalRounds} Rds | ${totalBlocks} Blks` : `${conciseFormatLabel} ${numRoundsPerBlock} Rds x ${totalBlocks} Blks | ${workTime}s/${restTime}s`;
                        const secondaryInstructionInterval = `Complete all blocks in order. Rest 1-2 minutes completely between blocks.`;

                        currentWODText = `WOD | ${conciseHeader}\nPURPOSE: ${purposeText}\n\n${secondaryInstructionInterval}\n\n${intervalBodyText.trim()}\n\n--- COACHING NOTES ---\nPACING: ${pacingNoteConcise}\nSCALING: ${scalingNoteConcise}`;

                        if (needsUnilateralNote) {
                            currentWODText += `\n\n${UNILATERAL_NOTE_INTERVAL}`;
                        }

                        instructionsHtml = `<p class="font-bold text-xl mb-3">${secondaryInstructionInterval}</p><div class="space-y-3">${blockInstructions}</div><p class="mt-4 text-sm text-yellow-400 font-bold">Pacing Notes: ${pacingNoteConcise}</p><p class="mt-2 text-sm text-gray-400">Use an external interval timer. Record the total number of reps completed for each block/movement (if applicable).</p><p class="mt-4 text-sm text-blue-400 font-bold">Scaling Notes: ${scalingNoteConcise}</p>`;

                        if (needsUnilateralNote) {
                            instructionsHtml += `<p class="mt-4 text-sm text-green-400 font-bold">UNILATERAL KEY ${GREEN_ASTERISK}: For movements marked with an asterisk, alternate sides during the ${workTime}-second work period.</p>`;
                        }

                        break;

                    default:
                        throw new Error("Invalid format.");
                }
            } catch(e) {
                console.error("WOD Generation Error:", e);
                document.getElementById('wod-error').textContent = `WOD Generation Error: ${e.message}. Please try a different selection.`;
                document.getElementById('wod-error').classList.remove('hidden');
                return;
            }
            
            // --- Update UI ---
            const displayedFormat = format.replace('LADDER 10-1', 'LADDER 10-1').replace('LADDER 20-2', 'LADDER 20-2').replace('INTERVAL_', '').replace('_', '/').replace('TABATA', 'TABATA');
            
            purposeDisplay.textContent = purposeText;
            formatDisplay.textContent = displayedFormat;
            goalDisplay.textContent = goalText;
            instructionsDiv.innerHTML = instructionsHtml;

            formDiv.classList.add('hidden');
            document.getElementById('wod-error').classList.add('hidden');
            resultDiv.classList.remove('hidden');
        }
        
        /**
         * Resets the UI to show the input form and updates the footer year.
         */
        function resetWOD() {
            document.getElementById('wod-result').classList.add('hidden'); 
            document.getElementById('wod-input-form').classList.remove('hidden');
            document.getElementById('wod-error').classList.add('hidden');
            currentWODText = "";
        }

        // Initialize on load
        window.onload = () => {
             const yearSpanPage = document.getElementById('current-year-page');
             const yearSpanModal = document.getElementById('current-year-modal');
             const currentYear = new Date().getFullYear();
             
             if (yearSpanPage) yearSpanPage.textContent = currentYear;
             if (yearSpanModal) yearSpanModal.textContent = currentYear;
             
             lucide.createIcons();
        }
    </script>
</body>
</html>
